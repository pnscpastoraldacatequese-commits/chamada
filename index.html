<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Presença da Catequese</title>
    <script>
        // Substitua os valores abaixo pelos seus dados do Firebase.
        // Você os encontra nas configurações do seu projeto.
        const firebaseConfig = {
            apiKey: "AIzaSyDqn5MejlYyNmXK-OZayhOZ5SrzN3YcNCM",
            authDomain: "dados-catequese.firebaseapp.com",
            projectId: "dados-catequese",
            storageBucket: "dados-catequese.firebasestorage.app",
            messagingSenderId: "420948905617",
            appId: "1:420948905617:web:b08e29cf50873ff804f930"
        };
        const initialAuthToken = null; // Deixe como null para testes locais
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Importa os módulos necessários do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, onSnapshot, getDocs, addDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais para o aplicativo
        let app, auth, db, userId, appId;

        setLogLevel('debug'); // Ativa logs de depuração para o Firestore

        // Função para inicializar a autenticação do Firebase
        async function initializeAuth() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = firebaseConfig.appId;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        document.getElementById('user-id-display').innerText = `ID do Usuário: ${userId}`;
                        setupUI();
                    } else {
                        console.log("Usuário desautenticado.");
                        userId = null;
                        document.getElementById('user-id-display').innerText = `ID do Usuário: Não Autenticado`;
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('main-content').style.display = 'block';
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
            }
        }

        // Variáveis globais para o aplicativo
        let selectedClass = null;
        let catechumens = [];
        let presenceRecords = {};

        // Datas de encontros e missas (configuráveis)
        const classDatesTuesday = [
            "2025-09-16", "2025-09-23", "2025-09-30", "2025-10-07", "2025-10-14", "2025-10-21", "2025-10-28", "2025-11-04", "2025-11-11", "2025-11-18", "2025-11-25", "2025-12-02", "2025-12-09"
        ];
        const classDatesSaturday = [
            "2025-09-20", "2025-09-27", "2025-10-04", "2025-10-11", "2025-10-18", "2025-10-25", "2025-11-01", "2025-11-08", "2025-11-15", "2025-11-22", "2025-11-29", "2025-12-06", "2025-12-13"
        ];
        const massDates = [
            "2025-09-21", "2025-09-28", "2025-10-05", "2025-10-12", "2025-10-19", "2025-10-26", "2025-11-02", "2025-11-09", "2025-11-16", "2025-11-23", "2025-11-30", "2025-12-07", "2025-12-14"
        ];

        // Mapeamento de status para cores e texto
        const statusMap = {
            'Presença': { class: 'bg-green-500 hover:bg-green-600', text: 'P' },
            'Falta': { class: 'bg-red-500 hover:bg-red-600', text: 'F' },
            'Falta Justificada': { class: 'bg-yellow-500 hover:bg-yellow-600', text: 'FJ' },
            'Falta Reposta': { class: 'bg-blue-500 hover:bg-blue-600', text: 'FR' },
            'Não Registrado': { class: 'bg-gray-200 hover:bg-gray-300', text: '-' }
        };

        // Função para configurar a interface do usuário após a autenticação
        async function setupUI() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';

            const urlHash = window.location.hash.substring(1);
            if (urlHash) {
                // Se a URL tiver um ID de turma, carrega direto
                await selectClass(urlHash);
            } else {
                // Caso contrário, mostra a lista de turmas
                document.getElementById('admin-button').style.display = 'block';
                await loadClasses();
            }
        }

        // Função para carregar as turmas do Firestore
        async function loadClasses() {
            const classesList = document.getElementById('classes-list');
            classesList.innerHTML = '';
            
            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);
                const classes = [];
                querySnapshot.forEach(doc => {
                    classes.push({ id: doc.id, name: doc.data().name });
                });

                if (classes.length === 0) {
                    showModal("Nenhuma turma encontrada. Por favor, adicione turmas na seção de Administração.");
                    document.getElementById('admin-info').style.display = 'block';
                }
                
                // Ordena as turmas por nome em ordem alfabética
                classes.sort((a, b) => a.name.localeCompare(b.name));

                classes.forEach(cls => {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="w-full text-left p-4 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">${cls.name}</button>`;
                    li.addEventListener('click', () => {
                        selectClass(cls.id);
                    });
                    classesList.appendChild(li);
                });
            } catch (error) {
                console.error("Erro ao carregar turmas:", error);
                showModal("Erro ao carregar as turmas. Por favor, tente novamente.");
            }
        }

        // Função para selecionar uma turma e carregar os dados
        async function selectClass(classId) {
            selectedClass = classId;
            document.getElementById('class-selector-section').style.display = 'none';
            document.getElementById('presence-section').style.display = 'block';
            document.getElementById('admin-button').style.display = 'none'; // Esconde o botão de admin
            
            window.location.hash = classId; // Adiciona o ID da turma na URL

            const classDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/classes`, classId));
            document.getElementById('class-title').innerText = classDoc.data()?.name || 'Turma Desconhecida';

            // Carrega os catequizandos para a turma selecionada do Firestore
            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const catechumensCollectionRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                const q = query(catechumensCollectionRef, where("classId", "==", classId));
                const querySnapshot = await getDocs(q);
                catechumens = [];
                querySnapshot.forEach(doc => {
                    catechumens.push({ id: doc.id, name: doc.data().name });
                });

                // Ordena os catequizandos por nome em ordem alfabética
                catechumens.sort((a, b) => a.name.localeCompare(b.name));

                if (catechumens.length === 0) {
                    showModal("Nenhum catequizando encontrado para esta turma. Por favor, adicione catequizandos na seção de Administração.");
                }

                // Inicia o listener em tempo real para os dados de presença
                listenForPresenceData();
            } catch (error) {
                console.error("Erro ao carregar catequizandos:", error);
                showModal("Erro ao carregar a lista de catequizandos.");
            }
        }

        // Função para voltar à tela de seleção de turmas
        function backToClasses() {
            selectedClass = null;
            catechumens = [];
            window.location.hash = ''; // Remove o ID da turma da URL
            document.getElementById('class-selector-section').style.display = 'block';
            document.getElementById('presence-section').style.display = 'none';
            document.getElementById('admin-button').style.display = 'block'; // Mostra o botão de admin
        }

        // Função para ouvir os dados de presença em tempo real
        function listenForPresenceData() {
            if (!db || !selectedClass) {
                console.error("Firestore não inicializado ou turma não selecionada.");
                return;
            }

            const q = query(collection(db, `artifacts/${appId}/public/data/presences`));

            onSnapshot(q, (querySnapshot) => {
                presenceRecords = {}; // Limpa os registros
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = `${data.catechumenId}_${data.date}`;
                    presenceRecords[key] = data.status;
                });
                renderPresenceTables();
            }, (error) => {
                console.error("Erro ao ouvir dados de presença:", error);
            });
        }

        // Função para renderizar as tabelas de presença
        function renderPresenceTables() {
            let classDatesToUse = [];
            const className = document.getElementById('class-title').innerText;
            if (className.toLowerCase().includes('terça')) {
                classDatesToUse = classDatesTuesday;
            } else if (className.toLowerCase().includes('sábado')) {
                classDatesToUse = classDatesSaturday;
            } else {
                classDatesToUse = classDatesTuesday; // Default para terça se não encontrar
            }
            renderTable('class-table-body', classDatesToUse, 'encontros');
            renderTable('mass-table-body', massDates, 'missas');
        }

        function renderTable(tableBodyId, dates, eventType) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';

            const tableHeader = document.getElementById(tableBodyId.replace('body', 'header'));
            tableHeader.innerHTML = '<th class="px-2 py-1 text-xs md:text-sm whitespace-nowrap">Nome</th>';
            dates.forEach(date => {
                const [year, month, day] = date.split('-');
                tableHeader.innerHTML += `<th class="px-2 py-1 text-xs md:text-sm whitespace-nowrap">${day}/${month}</th>`;
            });

            catechumens.forEach(catechumen => {
                const row = document.createElement('tr');
                row.className = "border-b border-gray-200";
                row.innerHTML = `<td class="p-2 font-medium">${catechumen.name}</td>`;

                dates.forEach(date => {
                    const status = presenceRecords[`${catechumen.id}_${date}`] || 'Não Registrado';
                    const { class: btnClass, text } = statusMap[status];

                    row.innerHTML += `
                        <td class="p-2">
                            <button class="${btnClass} w-8 h-8 md:w-10 md:h-10 text-white font-bold rounded-full flex items-center justify-center text-xs md:text-sm transition-colors"
                                onclick="updatePresenceStatus('${catechumen.id}', '${date}', '${status}')">
                                ${text}
                            </button>
                        </td>
                    `;
                });
                tableBody.appendChild(row);
            });
        }

        // Função para atualizar o status de presença
        window.updatePresenceStatus = async (catechumenId, date, currentStatus) => {
            if (!db || !userId) {
                console.error("Firestore não inicializado ou usuário não autenticado.");
                showModal("Erro: Não foi possível salvar o registro. Tente recarregar a página.");
                return;
            }

            const newStatus = cycleStatus(currentStatus);
            const recordKey = `${catechumenId}_${date}`;
            const recordRef = doc(db, `artifacts/${appId}/public/data/presences`, recordKey);

            try {
                const recordDoc = await getDoc(recordRef);

                if (recordDoc.exists()) {
                    await updateDoc(recordRef, {
                        status: newStatus,
                        lastUpdatedBy: userId,
                        lastUpdatedAt: new Date().toISOString()
                    });
                } else {
                    await setDoc(recordRef, {
                        classId: selectedClass,
                        catechumenId: catechumenId,
                        date: date,
                        status: newStatus,
                        createdBy: userId,
                        createdAt: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error("Erro ao atualizar o registro de presença:", error);
                showModal("Erro ao salvar o registro. Verifique a conexão.");
            }
        };

        // Função para ciclar entre os status
        function cycleStatus(currentStatus) {
            const statuses = ['Não Registrado', 'Presença', 'Falta', 'Falta Justificada', 'Falta Reposta'];
            const currentIndex = statuses.indexOf(currentStatus);
            return statuses[(currentIndex + 1) % statuses.length];
        }

        // Função para mostrar um modal de mensagem (substitui o alert)
        function showModal(message) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.innerHTML = message;
            modal.style.display = 'flex';
        }

        // Função para fechar o modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // --- Funções do Painel de Administração ---
        window.openAdminPanel = async function() {
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('reports-section').style.display = 'none';
            document.getElementById('management-section').style.display = 'block';
            await loadClassesForAdmin();
            await loadCatechumensForAdmin();
        }
        
        // Função para abrir a seção de relatórios
        function openReportsSection() {
            document.getElementById('reports-section').style.display = 'block';
            document.getElementById('management-section').style.display = 'none';
        }
        
        // Função para abrir a seção de gerenciamento
        function openManagementSection() {
            document.getElementById('reports-section').style.display = 'none';
            document.getElementById('management-section').style.display = 'block';
        }

        window.closeAdminPanel = function() {
            document.getElementById('admin-modal').style.display = 'none';
        }

        async function loadClassesForAdmin() {
            const classSelect = document.getElementById('new-catechumen-class');
            classSelect.innerHTML = '';
            const editClassSelect = document.getElementById('edit-class-select');
            editClassSelect.innerHTML = '';
            const transferClassSelect = document.getElementById('edit-catechumen-class-transfer');
            transferClassSelect.innerHTML = '<option value="" disabled selected>Transferir para outra turma</option>';
            const reportClassSelect = document.getElementById('report-class-select');
            reportClassSelect.innerHTML = '<option value="" disabled selected>Selecione a Turma</option>';


            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);
                const classes = [];
                querySnapshot.forEach(doc => {
                    classes.push({ id: doc.id, name: doc.data().name });
                });

                // Ordena as turmas por nome em ordem alfabética
                classes.sort((a, b) => a.name.localeCompare(b.name));

                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.innerText = cls.name;
                    classSelect.appendChild(option);

                    const editOption = document.createElement('option');
                    editOption.value = cls.id;
                    editOption.innerText = cls.name;
                    editClassSelect.appendChild(editOption);

                    const transferOption = document.createElement('option');
                    transferOption.value = cls.id;
                    transferOption.innerText = cls.name;
                    transferClassSelect.appendChild(transferOption);
                    
                    const reportOption = document.createElement('option');
                    reportOption.value = cls.id;
                    reportOption.innerText = cls.name;
                    reportClassSelect.appendChild(reportOption);
                });
            } catch (error) {
                console.error("Erro ao carregar turmas para o admin:", error);
                showModal("Erro ao carregar as turmas para o painel de administração.");
            }
        }
        
        async function loadCatechumensForAdmin() {
            const editCatechumenSelect = document.getElementById('edit-catechumen-select');
            editCatechumenSelect.innerHTML = '<option value="" disabled selected>Selecione o Catequizando</option>';
            const reportCatechumenSelect = document.getElementById('report-catechumen-select');
            reportCatechumenSelect.innerHTML = '<option value="" disabled selected>Selecione o Catequizando</option>';

            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const catechumensCollectionRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                const querySnapshot = await getDocs(catechumensCollectionRef);
                const catechumens = [];
                querySnapshot.forEach(doc => {
                    catechumens.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena os catequizandos por nome em ordem alfabética
                catechumens.sort((a, b) => a.name.localeCompare(b.name));

                catechumens.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.innerText = `${cat.name} (${cat.classId})`;
                    editCatechumenSelect.appendChild(option);
                    
                    const reportOption = document.createElement('option');
                    reportOption.value = cat.id;
                    reportOption.innerText = `${cat.name} (${cat.classId})`;
                    reportCatechumenSelect.appendChild(reportOption);
                });
            } catch (error) {
                console.error("Erro ao carregar catequizandos para o admin:", error);
                showModal("Erro ao carregar os catequizandos para o painel de administração.");
            }
        }

        window.addTurma = async function(event) {
            event.preventDefault();
            const classIdInput = document.getElementById('new-class-id');
            const classNameInput = document.getElementById('new-class-name');
            const classId = classIdInput.value.trim();
            const className = classNameInput.value.trim();

            if (!classId || !className) {
                showModal("Preencha o ID e o nome da turma.");
                return;
            }

            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const classRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
                await setDoc(classRef, {
                    name: className,
                    createdAt: new Date().toISOString()
                });
                classIdInput.value = '';
                classNameInput.value = '';
                showModal(`Turma "${className}" adicionada com sucesso!`);
                await loadClassesForAdmin(); // Atualiza a lista de turmas no painel
                await loadClasses(); // Atualiza a lista de turmas na tela principal
            } catch (error) {
                console.error("Erro ao adicionar turma:", error);
                showModal("Erro ao adicionar a turma. Verifique a conexão.");
            }
        }
        
        window.addCatequizando = async function(event) {
            event.preventDefault();
            const catechumenName = document.getElementById('new-catechumen-name').value;
            const classId = document.getElementById('new-catechumen-class').value;

            if (!catechumenName.trim() || !classId) {
                showModal("Preencha o nome do catequizando e selecione uma turma.");
                return;
            }

            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const catechumensCollectionRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                await addDoc(catechumensCollectionRef, {
                    name: catechumenName,
                    classId: classId,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('new-catechumen-name').value = '';
                showModal(`Catequizando "${catechumenName}" adicionado com sucesso!`);
                await loadCatechumensForAdmin();
            } catch (error) {
                console.error("Erro ao adicionar catequizando:", error);
                showModal("Erro ao adicionar o catequizando. Verifique a conexão.");
            }
        }
        
        window.editTurma = async function(event) {
            event.preventDefault();
            const classId = document.getElementById('edit-class-select').value;
            const newClassName = document.getElementById('edit-class-name').value;
            const newClassId = document.getElementById('edit-class-id').value;
            if (!classId || !newClassName || !newClassId) {
                showModal("Preencha o ID e o nome da turma.");
                return;
            }
            try {
                if (classId !== newClassId) {
                    // Move a turma e seus catequizandos para o novo ID
                    const oldDocRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
                    const newDocRef = doc(db, `artifacts/${appId}/public/data/classes`, newClassId);
                    const oldDoc = await getDoc(oldDocRef);
                    await setDoc(newDocRef, oldDoc.data());
                    await updateDoc(newDocRef, { name: newClassName });
                    const catechumensRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                    const q = query(catechumensRef, where("classId", "==", classId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(async (docSnap) => {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/catechumens`, docSnap.id), { classId: newClassId });
                    });
                    await deleteDoc(oldDocRef);
                } else {
                    const classRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
                    await updateDoc(classRef, { name: newClassName });
                }
                showModal(`Turma atualizada com sucesso!`);
                await loadClassesForAdmin();
                await loadClasses();
            } catch (error) {
                console.error("Erro ao editar turma:", error);
                showModal("Erro ao editar a turma. Verifique a conexão.");
            }
        }
        
        window.deleteTurma = async function() {
            const classId = document.getElementById('edit-class-select').value;
            if (!classId) {
                showModal("Selecione uma turma para excluir.");
                return;
            }
            if (confirm(`Tem certeza que deseja excluir a turma e todos os seus catequizandos?`)) {
                try {
                    const classRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
                    await deleteDoc(classRef);
                    const catechumensRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                    const q = query(catechumensRef, where("classId", "==", classId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(async (docSnap) => {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/catechumens`, docSnap.id));
                    });
                    showModal(`Turma excluída com sucesso!`);
                    await loadClassesForAdmin();
                    await loadClasses();
                } catch (error) {
                    console.error("Erro ao excluir turma:", error);
                    showModal("Erro ao excluir a turma. Verifique a conexão.");
                }
            }
        }

        window.editCatequizando = async function(event) {
            event.preventDefault();
            const catechumenId = document.getElementById('edit-catechumen-select').value;
            const newCatechumenName = document.getElementById('edit-catechumen-name').value;
            const newClassId = document.getElementById('edit-catechumen-class-transfer').value;
            if (!catechumenId) {
                showModal("Selecione um catequizando para editar.");
                return;
            }

            const updateData = {};
            if (newCatechumenName.trim()) {
                updateData.name = newCatechumenName;
            }
            if (newClassId) {
                updateData.classId = newClassId;
            }
            
            if (Object.keys(updateData).length === 0) {
                showModal("Preencha o nome ou selecione uma nova turma para atualizar.");
                return;
            }
            
            try {
                const catechumenRef = doc(db, `artifacts/${appId}/public/data/catechumens`, catechumenId);
                await updateDoc(catechumenRef, updateData);
                showModal(`Catequizando atualizado com sucesso!`);
                await loadCatechumensForAdmin();
            } catch (error) {
                console.error("Erro ao editar catequizando:", error);
                showModal("Erro ao editar o catequizando. Verifique a conexão.");
            }
        }
        
        window.deleteCatequizando = async function() {
            const catechumenId = document.getElementById('edit-catechumen-select').value;
            if (!catechumenId) {
                showModal("Selecione um catequizando para excluir.");
                return;
            }
            if (confirm(`Tem certeza que deseja excluir este catequizando?`)) {
                try {
                    const catechumenRef = doc(db, `artifacts/${appId}/public/data/catechumens`, catechumenId);
                    await deleteDoc(catechumenRef);
                    showModal(`Catequizando excluído com sucesso!`);
                    await loadCatechumensForAdmin();
                } catch (error) {
                    console.error("Erro ao excluir catequizando:", error);
                    showModal("Erro ao excluir o catequizando. Verifique a conexão.");
                }
            }
        }

        // --- Funções de Relatórios ---
        let currentClassReportData = null; // Armazena dados do relatório por turma
        let currentCatechumenReportData = null; // Armazena dados do relatório por catequizando

        window.generateReportByClass = async function() {
            const classId = document.getElementById('report-class-select').value;
            if (!classId) {
                showModal("Selecione uma turma para gerar o relatório.");
                return;
            }

            // Carrega os catequizandos da turma
            const catechumensInClass = [];
            const catechumensRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
            const qCatechumens = query(catechumensRef, where("classId", "==", classId));
            const querySnapshotCatechumens = await getDocs(qCatechumens);
            querySnapshotCatechumens.forEach(doc => {
                catechumensInClass.push({ id: doc.id, name: doc.data().name });
            });
            
            if (catechumensInClass.length === 0) {
                showModal("Nenhum catequizando encontrado nesta turma para gerar o relatório.");
                return;
            }
            
            // Carrega todos os registros de presença
            const allPresence = [];
            const presenceRef = collection(db, `artifacts/${appId}/public/data/presences`);
            const qPresence = query(presenceRef, where("classId", "==", classId));
            const querySnapshotPresence = await getDocs(qPresence);
            querySnapshotPresence.forEach(doc => {
                allPresence.push(doc.data());
            });

            // Lógica de cálculo de presença e faltas
            const classDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/classes`, classId));
            const className = classDoc.data()?.name || 'Turma';
            let classDatesToUse = [];
            if (className.toLowerCase().includes('terça')) {
                classDatesToUse = classDatesTuesday;
            } else if (className.toLowerCase().includes('sábado')) {
                classDatesToUse = classDatesSaturday;
            } else {
                classDatesToUse = classDatesTuesday; // Default para terça se não encontrar
            }
            const totalEvents = classDatesToUse.length + massDates.length;
            
            const reportData = catechumensInClass.map(cat => {
                const presenceCount = allPresence.filter(p => p.catechumenId === cat.id && p.status === 'Presença').length;
                const absenceCount = allPresence.filter(p => p.catechumenId === cat.id && p.status === 'Falta').length;
                const justifiedAbsenceCount = allPresence.filter(p => p.catechumenId === cat.id && p.status === 'Falta Justificada').length;
                const percent = totalEvents > 0 ? ((presenceCount / totalEvents) * 100).toFixed(2) : 0;
                return {
                    name: cat.name,
                    presence: presenceCount,
                    absence: absenceCount,
                    justified: justifiedAbsenceCount,
                    percentage: percent
                };
            });

            currentClassReportData = reportData; // Salva os dados para exportação
            
            let reportHtml = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold">Relatório da Turma: ${className}</h4>
                    <button id="export-class-report-button" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Exportar para CSV</button>
                </div>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="p-2">Nome</th>
                                <th class="p-2">Presença</th>
                                <th class="p-2">Falta</th>
                                <th class="p-2">Falta Justificada</th>
                                <th class="p-2">% Presença</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.map(data => `
                                <tr>
                                    <td class="p-2">${data.name}</td>
                                    <td class="p-2">${data.presence}</td>
                                    <td class="p-2">${data.absence}</td>
                                    <td class="p-2">${data.justified}</td>
                                    <td class="p-2">${data.percentage}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('report-results').innerHTML = reportHtml;
            document.getElementById('export-class-report-button').addEventListener('click', window.exportClassReportToCSV);
        }

        window.generateReportByCatechumen = async function() {
            const catechumenId = document.getElementById('report-catechumen-select').value;
            if (!catechumenId) {
                showModal("Selecione um catequizando para gerar o relatório.");
                return;
            }

            const allPresence = [];
            const presenceRef = collection(db, `artifacts/${appId}/public/data/presences`);
            const qPresence = query(presenceRef, where("catechumenId", "==", catechumenId));
            const querySnapshotPresence = await getDocs(qPresence);
            querySnapshotPresence.forEach(doc => {
                allPresence.push(doc.data());
            });
            
            if (allPresence.length === 0) {
                 showModal("Nenhum registro de presença encontrado para este catequizando.");
                return;
            }
            
            const catechumenDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/catechumens`, catechumenId));
            const catechumenName = catechumenDoc.data()?.name || 'Catequizando';
            const className = catechumenDoc.data()?.classId || 'Turma Desconhecida';

            currentCatechumenReportData = allPresence; // Salva os dados para exportação

            let reportHtml = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold">Relatório de Presença - ${catechumenName} (${className})</h4>
                    <button id="export-catechumen-report-button" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Exportar para CSV</button>
                </div>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="p-2">Data</th>
                                <th class="p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPresence.map(data => `
                                <tr>
                                    <td class="p-2">${data.date.split('-').reverse().join('/')}</td>
                                    <td class="p-2">${data.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('report-results').innerHTML = reportHtml;
            document.getElementById('export-catechumen-report-button').addEventListener('click', window.exportCatechumenReportToCSV);
        }
        
        // Função para exportar o relatório por turma
        window.exportClassReportToCSV = function() {
            if (!currentClassReportData) {
                showModal("Nenhum relatório de turma para exportar.");
                return;
            }

            let csv = "Nome,Presença,Falta,Falta Justificada,% Presença\n";
            currentClassReportData.forEach(row => {
                csv += `"${row.name}",${row.presence},${row.absence},${row.justified},"${row.percentage}%"\n`;
            });
            
            const className = document.getElementById('report-class-select').options[document.getElementById('report-class-select').selectedIndex].text;
            downloadCSV(csv, `relatorio_turma_${className}.csv`);
        }
        
        // Função para exportar o relatório por catequizando
        window.exportCatechumenReportToCSV = function() {
             if (!currentCatechumenReportData) {
                showModal("Nenhum relatório de catequizando para exportar.");
                return;
            }

            let csv = "Data,Status\n";
            currentCatechumenReportData.forEach(row => {
                const [year, month, day] = row.date.split('-');
                csv += `${day}/${month},${row.status}\n`;
            });

            const catechumenName = document.getElementById('report-catechumen-select').options[document.getElementById('report-catechumen-select').selectedIndex].text;
            downloadCSV(csv, `relatorio_catequizando_${catechumenName}.csv`);
        }
        
        // Função utilitária para baixar o arquivo CSV
        function downloadCSV(csv, filename) {
            const BOM = "\uFEFF"; // Byte Order Mark para compatibilidade com Excel
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Lógica do botão de Administração
        document.getElementById('admin-button').addEventListener('click', window.openAdminPanel);
        document.getElementById('add-class-form').onsubmit = window.addTurma;
        document.getElementById('add-catechumen-form').onsubmit = window.addCatequizando;
        document.getElementById('edit-class-form').onsubmit = window.editTurma;
        document.getElementById('delete-class-button').addEventListener('click', window.deleteTurma);
        document.getElementById('edit-catechumen-form').onsubmit = window.editCatequizando;
        document.getElementById('delete-catechumen-button').addEventListener('click', window.deleteCatequizando);


        // Conecta os botões de fechar e voltar
        document.getElementById('back-button').addEventListener('click', backToClasses);
        document.getElementById('close-modal-button').addEventListener('click', closeModal);
        document.getElementById('close-admin-panel-button').addEventListener('click', closeAdminPanel);
        
        // Conecta os botões de navegação do painel
        document.getElementById('reports-tab-button').addEventListener('click', openReportsSection);
        document.getElementById('management-tab-button').addEventListener('click', openManagementSection);
        
        // Conecta os botões de relatórios
        document.getElementById('generate-class-report-button').addEventListener('click', window.generateReportByClass);
        document.getElementById('generate-catechumen-report-button').addEventListener('click', window.generateReportByCatechumen);

        // Inicia a aplicação quando a janela carrega
        window.onload = initializeAuth;
    </script>
</head>

<body class="bg-gray-50 font-sans text-gray-800 antialiased">

    <!-- Modal para mensagens -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-sm text-center">
            <h3 class="text-xl font-semibold mb-4">Atenção</h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="close-modal-button" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Modal para Painel de Administração -->
    <div id="admin-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-11/12 max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold">Painel de Administração</h3>
                <button id="close-admin-panel-button" class="text-gray-500 hover:text-gray-800 transition-colors">&times;</button>
            </div>
            
            <div class="space-y-6">
                <!-- Abas de navegação -->
                <div class="flex justify-center border-b border-gray-200">
                    <button id="management-tab-button" class="py-2 px-4 text-center text-indigo-600 font-semibold border-b-2 border-indigo-600 focus:outline-none">Gerenciamento</button>
                    <button id="reports-tab-button" class="py-2 px-4 text-center text-gray-600 font-semibold border-b-2 border-transparent hover:border-gray-300 focus:outline-none">Relatórios</button>
                </div>

                <!-- Seção de Gerenciamento -->
                <div id="management-section">
                    <!-- Seção Adicionar Turma -->
                    <div class="bg-gray-100 p-4 rounded-xl">
                        <h4 class="text-lg font-bold mb-2">Adicionar Turma</h4>
                        <form id="add-class-form">
                            <div class="flex flex-col md:flex-row gap-2">
                                <input type="text" id="new-class-id" placeholder="ID da turma (ex: T_111)" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <input type="text" id="new-class-name" placeholder="Nome da nova turma (ex: Turma A)" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button type="submit" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Adicionar</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Seção Editar/Excluir Turma -->
                    <div class="bg-gray-100 p-4 rounded-xl">
                        <h4 class="text-lg font-bold mb-2">Editar/Excluir Turma</h4>
                        <form id="edit-class-form">
                            <div class="flex flex-col md:flex-row gap-2 mb-2">
                                <select id="edit-class-select" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="" disabled selected>Selecione a Turma</option>
                                </select>
                                <input type="text" id="edit-class-name" placeholder="Novo nome da turma" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <input type="text" id="edit-class-id" placeholder="Novo ID da turma" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="flex-grow bg-green-500 text-white p-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">Atualizar</button>
                                <button type="button" id="delete-class-button" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Excluir</button>
                            </div>
                        </form>
                    </div>

                    <!-- Seção Adicionar Catequizando -->
                    <div class="bg-gray-100 p-4 rounded-xl">
                        <h4 class="text-lg font-bold mb-2">Adicionar Catequizando</h4>
                        <form id="add-catechumen-form">
                            <div class="flex flex-col md:flex-row gap-2 mb-2">
                                <input type="text" id="new-catechumen-name" placeholder="Nome do catequizando" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <select id="new-catechumen-class" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="" disabled selected>Selecione a Turma</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Adicionar Catequizando</button>
                        </form>
                    </div>
                    
                    <!-- Seção Editar/Excluir Catequizando -->
                    <div class="bg-gray-100 p-4 rounded-xl">
                        <h4 class="text-lg font-bold mb-2">Editar/Excluir Catequizando</h4>
                        <form id="edit-catechumen-form">
                            <div class="flex flex-col md:flex-row gap-2 mb-2">
                                <select id="edit-catechumen-select" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="" disabled selected>Selecione o Catequizando</option>
                                </select>
                                <input type="text" id="edit-catechumen-name" placeholder="Altera nome" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <select id="edit-catechumen-class-transfer" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="" disabled selected>Transferir para turma</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="flex-grow bg-green-500 text-white p-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">Atualizar</button>
                                <button type="button" id="delete-catechumen-button" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Excluir</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Seção de Relatórios -->
                <div id="reports-section" class="hidden">
                    <!-- Relatório por Turma -->
                    <div class="bg-gray-100 p-4 rounded-xl mb-4">
                        <h4 class="text-lg font-bold mb-2">Relatório por Turma</h4>
                        <div class="flex flex-col md:flex-row gap-2">
                            <select id="report-class-select" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="" disabled selected>Selecione a Turma</option>
                            </select>
                            <button id="generate-class-report-button" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Gerar Relatório</button>
                        </div>
                    </div>
                    
                    <!-- Relatório por Catequizando -->
                    <div class="bg-gray-100 p-4 rounded-xl">
                        <h4 class="text-lg font-bold mb-2">Relatório por Catequizando</h4>
                        <div class="flex flex-col md:flex-row gap-2">
                            <select id="report-catechumen-select" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="" disabled selected>Selecione o Catequizando</option>
                            </select>
                            <button id="generate-catechumen-report-button" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Gerar Relatório</button>
                        </div>
                    </div>

                    <!-- Área de resultados do relatório -->
                    <div id="report-results" class="mt-6 p-4 bg-white rounded-xl shadow-inner">
                        <p class="text-gray-500 text-center">Os relatórios aparecerão aqui.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Seção de Cabeçalho -->
    <header class="bg-indigo-600 text-white p-6 md:p-8 shadow-md">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-2xl md:text-3xl font-bold">Registro de Presença</h1>
            <!-- Botão de Administração -->
            <button id="admin-button" class="bg-indigo-700 hover:bg-indigo-800 text-white font-semibold py-2 px-4 rounded-full transition-colors">
                Administração
            </button>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 md:p-6 mt-4">
        <!-- Estado de Carregamento -->
        <div id="loading" class="flex items-center justify-center flex-col h-64 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500"></div>
            <p class="mt-4 text-lg text-gray-600">Carregando...</p>
        </div>

        <!-- Conteúdo Principal da Aplicação -->
        <div id="main-content" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex justify-end mb-4 text-sm text-gray-500">
                    <span id="user-id-display"></span>
                </div>

                <!-- Seção de Seleção de Turma -->
                <div id="class-selector-section">
                    <h2 class="text-xl md:text-2xl font-semibold mb-4 text-center">Selecione a Turma</h2>
                    <p id="admin-info" class="text-center text-sm text-gray-500 mb-4 hidden">
                        Para adicionar turmas, clique no botão "Administração" acima.
                    </p>
                    <ul id="classes-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Botões de turma serão injetados aqui via JS -->
                    </ul>
                </div>

                <!-- Seção de Registro de Presença -->
                <div id="presence-section" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <button id="back-button" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="class-title" class="text-xl md:text-2xl font-semibold text-center flex-grow"></h2>
                    </div>

                    <!-- Tabela de Presença de Encontros -->
                    <h3 class="text-xl font-semibold mt-6 mb-2">Presença em Encontros</h3>
                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg mb-6">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr id="class-table-header">
                                    <th>Nome</th>
                                </tr>
                            </thead>
                            <tbody id="class-table-body">
                                <!-- Dados da tabela serão injetados aqui via JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Tabela de Presença de Missas -->
                    <h3 class="text-xl font-semibold mb-2">Presença em Missas</h3>
                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr id="mass-table-header">
                                    <th>Nome</th>
                                </tr>
                            </thead>
                            <tbody id="mass-table-body">
                                <!-- Dados da tabela serão injetados aqui via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

</html>
