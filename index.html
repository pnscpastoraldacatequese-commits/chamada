<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Presença da Catequese</title>
    <script>
        // Substitua os valores abaixo pelos seus dados do Firebase.
        // Você os encontra nas configurações do seu projeto.
        const __firebase_config = {
            apiKey: "AIzaSyDqn5MejlYyNmXK-OZayhOZ5SrzN3YcNCM",
            authDomain: "dados-catequese.firebaseapp.com",
            projectId: "dados-catequese",
            storageBucket: "dados-catequese.firebasestorage.app",
            messagingSenderId: "420948905617",
            appId: "1:420948905617:web:b08e29cf50873ff804f930"
        };
        const __initial_auth_token = null; // Deixe como null para testes locais
        const __app_id = __firebase_config.appId;
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Importa os módulos necessários do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, onSnapshot, getDocs, addDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais para configuração do Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth, userId;

        // Função para inicializar o Firebase
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. The app will not function correctly.");
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Ativa logs de depuração para o Firestore

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener para o estado de autenticação do usuário
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        document.getElementById('user-id-display').innerText = `ID do Usuário: ${userId}`;
                        setupUI();
                    } else {
                        console.log("Usuário desautenticado.");
                        userId = null;
                        document.getElementById('user-id-display').innerText = `ID do Usuário: Não Autenticado`;
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('main-content').style.display = 'block';
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
            }
        }

        // Variáveis globais para o aplicativo
        let selectedClass = null;
        let catechumens = [];
        let presenceRecords = {};

        // Datas de encontros e missas (configuráveis)
        const eventDates = [
            "2025-09-14", "2025-09-21", "2025-09-28",
            "2025-10-05", "2025-10-12", "2025-10-19", "2025-10-26"
        ];

        // Mapeamento de status para cores e texto
        const statusMap = {
            'Presença': { class: 'bg-green-500 hover:bg-green-600', text: 'P' },
            'Falta': { class: 'bg-red-500 hover:bg-red-600', text: 'F' },
            'Falta Justificada': { class: 'bg-yellow-500 hover:bg-yellow-600', text: 'FJ' },
            'Falta Reposta': { class: 'bg-blue-500 hover:bg-blue-600', text: 'FR' },
            'Não Registrado': { class: 'bg-gray-200 hover:bg-gray-300', text: '-' }
        };

        // Função para configurar a interface do usuário após a autenticação
        async function setupUI() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            await loadClasses();
        }

        // Função para carregar as turmas do Firestore
        async function loadClasses() {
            const classesList = document.getElementById('classes-list');
            classesList.innerHTML = '';
            
            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);
                const classes = [];
                querySnapshot.forEach(doc => {
                    classes.push({ id: doc.id, name: doc.data().name });
                });

                if (classes.length === 0) {
                    showModal("Nenhuma turma encontrada. Por favor, adicione turmas na seção de Administração.");
                    document.getElementById('admin-info').style.display = 'block';
                }

                classes.forEach(cls => {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="w-full text-left p-4 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">${cls.name}</button>`;
                    li.addEventListener('click', () => {
                        selectClass(cls.id);
                    });
                    classesList.appendChild(li);
                });
            } catch (error) {
                console.error("Erro ao carregar turmas:", error);
                showModal("Erro ao carregar as turmas. Por favor, tente novamente.");
            }
        }

        // Função para selecionar uma turma e carregar os dados
        async function selectClass(classId) {
            selectedClass = classId;
            document.getElementById('class-selector-section').style.display = 'none';
            document.getElementById('presence-section').style.display = 'block';

            const classDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/classes`, classId));
            document.getElementById('class-title').innerText = classDoc.data()?.name || 'Turma Desconhecida';

            // Carrega os catequizandos para a turma selecionada do Firestore
            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const catechumensCollectionRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                const q = query(catechumensCollectionRef, where("classId", "==", classId));
                const querySnapshot = await getDocs(q);
                catechumens = [];
                querySnapshot.forEach(doc => {
                    catechumens.push({ id: doc.id, name: doc.data().name });
                });

                if (catechumens.length === 0) {
                    showModal("Nenhum catequizando encontrado para esta turma. Por favor, adicione catequizandos na seção de Administração.");
                }

                // Inicia o listener em tempo real para os dados de presença
                listenForPresenceData();
            } catch (error) {
                console.error("Erro ao carregar catequizandos:", error);
                showModal("Erro ao carregar a lista de catequizandos.");
            }
        }

        // Função para voltar à tela de seleção de turmas
        function backToClasses() {
            selectedClass = null;
            catechumens = [];
            document.getElementById('class-selector-section').style.display = 'block';
            document.getElementById('presence-section').style.display = 'none';
        }

        // Função para ouvir os dados de presença em tempo real
        function listenForPresenceData() {
            if (!db || !selectedClass) {
                console.error("Firestore não inicializado ou turma não selecionada.");
                return;
            }

            const q = query(collection(db, `artifacts/${appId}/public/data/presences`));

            onSnapshot(q, (querySnapshot) => {
                presenceRecords = {}; // Limpa os registros
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = `${data.catechumenId}_${data.date}`;
                    presenceRecords[key] = data.status;
                });
                renderPresenceTable();
            }, (error) => {
                console.error("Erro ao ouvir dados de presença:", error);
            });
        }

        // Função para renderizar a tabela de presença
        function renderPresenceTable() {
            const tableBody = document.getElementById('presence-table-body');
            tableBody.innerHTML = '';

            // Constrói o cabeçalho da tabela com as datas
            const tableHeader = document.getElementById('presence-table-header');
            tableHeader.innerHTML = '<th>Nome</th>';
            eventDates.forEach(date => {
                tableHeader.innerHTML += `<th class="px-2 py-1 text-xs md:text-sm whitespace-nowrap">${date.substring(5)}</th>`;
            });

            catechumens.forEach(catechumen => {
                const row = document.createElement('tr');
                row.className = "border-b border-gray-200";
                row.innerHTML = `<td class="p-2 font-medium">${catechumen.name}</td>`;

                eventDates.forEach(date => {
                    const status = presenceRecords[`${catechumen.id}_${date}`] || 'Não Registrado';
                    const { class: btnClass, text } = statusMap[status];

                    row.innerHTML += `
                        <td class="p-2">
                            <button class="${btnClass} w-8 h-8 md:w-10 md:h-10 text-white font-bold rounded-full flex items-center justify-center text-xs md:text-sm transition-colors"
                                onclick="updatePresenceStatus('${catechumen.id}', '${date}', '${status}')">
                                ${text}
                            </button>
                        </td>
                    `;
                });
                tableBody.appendChild(row);
            });
        }

        // Função para atualizar o status de presença
        window.updatePresenceStatus = async (catechumenId, date, currentStatus) => {
            if (!db || !userId) {
                console.error("Firestore não inicializado ou usuário não autenticado.");
                showModal("Erro: Não foi possível salvar o registro. Tente recarregar a página.");
                return;
            }

            const newStatus = cycleStatus(currentStatus);
            const recordKey = `${catechumenId}_${date}`;
            const recordRef = doc(db, `artifacts/${appId}/public/data/presences`, recordKey);

            try {
                const recordDoc = await getDoc(recordRef);

                if (recordDoc.exists()) {
                    await updateDoc(recordRef, {
                        status: newStatus,
                        lastUpdatedBy: userId,
                        lastUpdatedAt: new Date().toISOString()
                    });
                } else {
                    await setDoc(recordRef, {
                        classId: selectedClass,
                        catechumenId: catechumenId,
                        date: date,
                        status: newStatus,
                        createdBy: userId,
                        createdAt: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error("Erro ao atualizar o registro de presença:", error);
                showModal("Erro ao salvar o registro. Verifique a conexão.");
            }
        };

        // Função para ciclar entre os status
        function cycleStatus(currentStatus) {
            const statuses = ['Não Registrado', 'Presença', 'Falta', 'Falta Justificada', 'Falta Reposta'];
            const currentIndex = statuses.indexOf(currentStatus);
            return statuses[(currentIndex + 1) % statuses.length];
        }

        // Função para mostrar um modal de mensagem (substitui o alert)
        function showModal(message) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.innerHTML = message;
            modal.style.display = 'flex';
        }

        // Função para fechar o modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // --- Funções do Painel de Administração ---
        window.openAdminPanel = async function() {
            document.getElementById('admin-modal').style.display = 'flex';
            await loadClassesForAdmin();
        }

        window.closeAdminPanel = function() {
            document.getElementById('admin-modal').style.display = 'none';
        }

        async function loadClassesForAdmin() {
            const classSelect = document.getElementById('new-catechumen-class');
            classSelect.innerHTML = '';

            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);
                querySnapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.innerText = doc.data().name;
                    classSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar turmas para o admin:", error);
                showModal("Erro ao carregar as turmas para o painel de administração.");
            }
        }
        
        window.addTurma = async function(event) {
            event.preventDefault();
            const className = document.getElementById('new-class-name').value;
            if (!className.trim()) {
                showModal("O nome da turma não pode estar vazio.");
                return;
            }

            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                await addDoc(classesCollectionRef, {
                    name: className,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('new-class-name').value = '';
                showModal(`Turma "${className}" adicionada com sucesso!`);
                await loadClassesForAdmin(); // Atualiza a lista de turmas no painel
                await loadClasses(); // Atualiza a lista de turmas na tela principal
            } catch (error) {
                console.error("Erro ao adicionar turma:", error);
                showModal("Erro ao adicionar a turma. Verifique a conexão.");
            }
        }

        window.addCatequizando = async function(event) {
            event.preventDefault();
            const catechumenName = document.getElementById('new-catechumen-name').value;
            const classId = document.getElementById('new-catechumen-class').value;

            if (!catechumenName.trim() || !classId) {
                showModal("Preencha o nome do catequizando e selecione uma turma.");
                return;
            }

            try {
                if (!db) throw new Error("Firestore is not initialized.");
                const catechumensCollectionRef = collection(db, `artifacts/${appId}/public/data/catechumens`);
                await addDoc(catechumensCollectionRef, {
                    name: catechumenName,
                    classId: classId,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('new-catechumen-name').value = '';
                showModal(`Catequizando "${catechumenName}" adicionado com sucesso!`);
            } catch (error) {
                console.error("Erro ao adicionar catequizando:", error);
                showModal("Erro ao adicionar o catequizando. Verifique a conexão.");
            }
        }

        // Lógica do botão de Administração
        document.getElementById('admin-button').addEventListener('click', window.openAdminPanel);
        document.getElementById('add-class-form').onsubmit = window.addTurma;
        document.getElementById('add-catechumen-form').onsubmit = window.addCatequizando;


        // Inicia a aplicação quando a janela carrega
        window.onload = initializeFirebase;
    </script>
</head>

<body class="bg-gray-50 font-sans text-gray-800 antialiased">

    <!-- Modal para mensagens -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-sm text-center">
            <h3 class="text-xl font-semibold mb-4">Atenção</h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Modal para Painel de Administração -->
    <div id="admin-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-11/12 max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold">Painel de Administração</h3>
                <button onclick="window.closeAdminPanel()" class="text-gray-500 hover:text-gray-800 transition-colors">&times;</button>
            </div>
            
            <div class="space-y-6">
                <!-- Seção Adicionar Turma -->
                <div class="bg-gray-100 p-4 rounded-xl">
                    <h4 class="text-lg font-bold mb-2">Adicionar Turma</h4>
                    <form id="add-class-form">
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="text" id="new-class-name" placeholder="Nome da nova turma (ex: Turma A)" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button type="submit" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Adicionar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Seção Adicionar Catequizando -->
                <div class="bg-gray-100 p-4 rounded-xl">
                    <h4 class="text-lg font-bold mb-2">Adicionar Catequizando</h4>
                    <form id="add-catechumen-form">
                        <div class="flex flex-col md:flex-row gap-2 mb-2">
                            <input type="text" id="new-catechumen-name" placeholder="Nome do catequizando" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <select id="new-catechumen-class" required class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="" disabled selected>Selecione a Turma</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">Adicionar Catequizando</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Seção de Cabeçalho -->
    <header class="bg-indigo-600 text-white p-6 md:p-8 shadow-md">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-2xl md:text-3xl font-bold">Registro de Presença</h1>
            <!-- Botão de Administração -->
            <button id="admin-button" class="bg-indigo-700 hover:bg-indigo-800 text-white font-semibold py-2 px-4 rounded-full transition-colors">
                Administração
            </button>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 md:p-6 mt-4">
        <!-- Estado de Carregamento -->
        <div id="loading" class="flex items-center justify-center flex-col h-64 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500"></div>
            <p class="mt-4 text-lg text-gray-600">Carregando...</p>
        </div>

        <!-- Conteúdo Principal da Aplicação -->
        <div id="main-content" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex justify-end mb-4 text-sm text-gray-500">
                    <span id="user-id-display"></span>
                </div>

                <!-- Seção de Seleção de Turma -->
                <div id="class-selector-section">
                    <h2 class="text-xl md:text-2xl font-semibold mb-4 text-center">Selecione sua Turma</h2>
                    <p id="admin-info" class="text-center text-sm text-gray-500 mb-4 hidden">
                        Para adicionar turmas, clique no botão "Administração" acima.
                    </p>
                    <ul id="classes-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Botões de turma serão injetados aqui via JS -->
                    </ul>
                </div>

                <!-- Seção de Registro de Presença -->
                <div id="presence-section" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="backToClasses()" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="class-title" class="text-xl md:text-2xl font-semibold text-center flex-grow"></h2>
                    </div>

                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr id="presence-table-header">
                                    <!-- Cabeçalho da tabela será injetado aqui via JS -->
                                </tr>
                            </thead>
                            <tbody id="presence-table-body">
                                <!-- Dados da tabela serão injetados aqui via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>
</body>

</html>
